---
title: "Introduction to FlowSOM analyse"
author: "Anja Bråthen Kristoffersen"
date: "23 March 2022"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document describes the different lines of the file "runFlowSOM_analyse.R". To perform your own flowSOM analysis save the files "runFlowSOM_analyse.R" and  "FlowSOM_analyse.R" from github https://github.com/folkehelseinstituttet/cytof give it a new name and change the necessary paths and values throughout the document to use it on your own data. The file "FlowSOM_analyse.R" is sourced from the file "runFlowSOM_analyse.R" see also the explanatory file called "Introduction to FlowSOM_analyse.R". These documents only make a clustering of your data and some additional files that later will be used when analysing the flowSOM data together with metadata, examples of analysing of the clustering data together with metadata can be found in "runResults_Regression_Clusters.R" and "resultater_Regression_clusters.Rmd". 


This document starts with removing everything that you may already have in R to make sure you start with no previous data. The removing is done by using the functions rm() and ls(). The function ls() list all objects in R while rm() remove everything in the list included.

```{r, eval=F, echo=T}
rm(list = ls())
```

Then some librarys are loaded. If you do not have these libraries installed you have to install them by using the function install.packages("LIBRARY NAME")

```{r, eval=F, echo=T}
library(ComplexHeatmap)
library(gridExtra)
library(ggplot2)
library(grid)
```

This chunk is optional. If you want the clustering of the median signal to be clustered on markers the order will not be used. But if you do not want to cluster the markers this will give the order you want the markers to be shown in.  

```{r, eval=F, echo=T}
orderPanel1 <- c("X89Y_CD45", "X116Cd_CD3", "X145Nd_CD4", "X113Cd_CD8", "X111Cd_CD19", "X152Sm_TCRgd", "X166Er_TCRVa7.2", "X149Sm_CD25", 
       "X158Gd_CD27", "X160Gd_CD28", "X143Nd_CD127", "X172Yb_CD38", "X167Er_CCR7", "X155Gd_CD45RA", "X114Cd_HLADR", "X146Nd_IgD", "X159Tb_IgG",
       "X156Gd_CXCR3", "X153Eu_CCR4", "X141Pr_CCR6", "X171Yb_CXCR5", "X168Er_ICOS", "X142Nd_KLRG1", "X150Nd_CD134_OX40", "X154Sm_TIGIT",
       "X161Dy_CD160", "X164Dy_CD161", "X162Dy_CD95", "X163Dy_CRTH2", "X165Ho_CD85j", "X169Tm_NKG2A", "X173Yb_CD141", "X174Yb_CD279_PD.1",
       "X175Lu_CD14", "X148Nd_CD16", "X176Yb_CD56", "X106Cd_CD57", "X209Bi_CD11b", "X147Sm_CD11c", "X112Cd_CD5", "X144Nd_CD15", "X170Er_CD169", "X151Eu_CD123")

orderPanel2 <- c("X89Y_CD45", "X116Cd_CD3", "X113Cd_CD8", "X145Nd_CD4",  "X111Cd_CD19",  "X153Eu_CXCR5.CD185", 
       "X114Cd_HLADR", "X175Lu_CD14", "X209Bi_CD16",  "X176Yb_CD56", "X106Cd_CD57", "X158Gd_CD27",
       "X160Gd_CD28", "X169Tm_CD25", "X172Yb_CD38", "X112Cd_CD44", "X143Nd_CD127.IL7Ra",  "X167Er_CCR7.CD197",
       "X155Gd_CD45RA", "X162Dy_FoxP3", "X170Er_CTLA.4.CD152", "X163Dy_CD33",  "X154Sm_CD272.BTLA", "X110Cd_CD107a",
       "X161Dy_IL.17A", "X166Er_IL.10", "X164Dy_Perforin", "X171Yb_GranzymeB", "X148Nd_CD274.PD.L1",  
       "X173Yb_CD273.PD.L2", "X159Tb_GM.CSF",   "X168Er_CD154.CD40L", "X174Yb_CD279.PD1", "X141Pr_CD223.LAG3", 
       "X147Sm_TIM.3",  "X151Eu_CD137.4.1BB",  "X165Ho_IFNg", "X142Nd_IL.1b", "X156Gd_IL.6", "X166Er_IL.10", 
       "X152Sm_TCRgd", "X151Eu_CD137.4.1BB", "X149Sm_IL.12p70", "X150Nd_MIP.1b")
```


then the scriptPath has to be updated to where you have saved your script. Read the data you want to analyse. and decide which files you want to use in this analyses.


```{r, eval=F, echo=T}
scriptPath <- fs::path("H:", "git", "cytof")
#scriptPath <- fs::path("C:", "CyToF data", "fra github")

source(fs::path(scriptPath, "readDataToAnalysePanel2.R"))

tamed <- as.character(dInfo$filenames)
tamed <- tamed[!grepl("FHI005", tamed)] #denne oppfører seg helt rart og tas ut av analysen.
tamed <- tamed[!grepl("Ref1", tamed)] #denne oppfører seg helt rart og tas ut av analysen.
tamed
```

ks is then assigned to be a vector with the number of clusters you want to analyse. Here you could use one or more numbers. FlowSOM requires the dimensions of the SOM to be specified, which is a default of 100 total clusters. Then, metaclusters are formed by combining these small clusters. Prior to the metaclustering, the 100 clusters are all the same. After different types of metaclustering (different ks), some of these final clusters may consist of the exact same initial clusters and some will be different. xdim and ydim tells how many nodes that flowSOM will use that later will be clustered to k clusters defined in ks. By setting xdim and ydim to 14 there will be 14*14 = 196 nodes, so the ks has to be less than 196 and probably as a rule at most half of the number of nodes preferably less. The more nodes and cells you choose the longer time will the analysis take. But you can start the script and leave it running alone. The variable n_per_file tells how many cells to use per file.

```{r, eval=F, echo=T}
ks <- c(40, 50, 60)
n_per_file <- 25000
xdim <- 14
ydim <- 14
```

Here the path to where you want to save the data is assigned, this has to be changed according to your data. Together with a seed that ensure that you get the same result if you run the script one more time. The seed has to be changed to randomly draw another set of cells to analyse. If selectedEvents are TRUE channel has to be given as well. selectedEvents tells if you will draw from all cells or only from a selected number of cells here by using channel equal to the colnames in posNeg (the list for each file of 0 (negative), 1 (positive/low), 2 (high))

```{r, eval=F, echo=T}
utSti <- fs::path("F:", "Forskningsprosjekter", "PDB 2794 - Immune responses aga_", "Forskningsfiler", "JOBO", "CyTOF", "Analyse i R OUS", "Resultat_Panel_2_ALLE")
seed <- 12345 #nb må endres vil man vil gjøre et annet uttrekk
selectedEvents <- FALSE
channel <- NULL
o <- orderPanel2
column_cluster <- FALSE

source(fs::path(scriptPath, "FlowSOM_analyse.R"))
```

By choosing another seed and source again you will have another run of the same script, just with another random generation of cells.  


```{r, eval=F, echo=T}
seed <- 54321 #nb må endres vil man vil gjøre et annet uttrekk
source(fs::path(scriptPath, "FlowSOM_analyse.R"))
```

The abow code made a run for all cells and sourced the file "FlowSOM_analyse.R" which produced the clusters see "introduction to FlowSOM_analyse.docx". Below only B cells, selected by gating for CD3 positive, CD45 positive and CD4. positive. Not all files have that many B cells so the number of cells to be used for clustering per file has to be reduced. When number of cells for clustering is reduced also the dimension of the SOM should be reduced, here xdim = ydim = 10 is choosen, resulting in 100 nodes. Also, the number of different clusters expected when only clustering on B cells are reduced so the chosen ks are her 15, 20, 25, 30, 35 and 40.   


```{r, eval=F, echo=T}
for(j in 1:length(posNeg)){
  posNeg[[j]]$CD3CD45CD4 <- posNeg[[j]]$CD3 & posNeg[[j]]$CD45 & posNeg[[j]]$CD4
}

utSti <- fs::path("F:", "Forskningsprosjekter", "PDB 2794 - Immune responses aga_", "Forskningsfiler", "JOBO", "CyTOF", "Analyse i R OUS", "Resulta_Panel_2_ALLE_CD4_test")
seed <- 45903#nb må endres vil man vil gjøre et annet uttrekk
selectedEvents <- TRUE
channel <- "CD3CD45CD4"
n_per_file <- 4250
ks <- c(15, 20, 25, 30, 35, 40)
xdim <- 10
ydim <- 10
o <- orderPanel2
column_cluster <- FALSE

source(fs::path(scriptPath, "FlowSOM_analyse.R"))
```

And then an example for T cells where CD8 are used for gating instead of CD4


```{r, eval=F, echo=T}
for(j in 1:length(posNeg)){
  posNeg[[j]]$CD3CD45CD8 <- posNeg[[j]]$CD3 & posNeg[[j]]$CD45 & posNeg[[j]]$CD8
}

utSti <- fs::path("F:", "Forskningsprosjekter", "PDB 2794 - Immune responses aga_", "Forskningsfiler", "JOBO", "CyTOF", "Analyse i R OUS", "Resulta_Panel_2_ALLE_CD8")
seed <- 45902#nb må endres vil man vil gjøre et annet uttrekk
selectedEvents <- TRUE
channel <- "CD3CD45CD8"
n_per_file <- 4000
ks <- c(15, 20, 25, 30, 35, 40)
xdim <- 10
ydim <- 10
o <- orderPanel2
column_cluster <- FALSE


source(fs::path(scriptPath, "FlowSOM_analyse.R"))


```