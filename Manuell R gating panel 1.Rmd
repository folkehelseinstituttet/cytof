---
title: "Manuel gating panel 1"
author: "Anja Bråthen Kristoffersen"
date: "1 3 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,include = F, comment= FALSE, message= FALSE}
#posNegPath <- fs::path("F:", "Forskningsprosjekter", "PDB 2794 - Immune responses aga_", "Forskningsfiler", "JOBO", "CyTOF","Analyse i R OUS", "Resultat_Panel_1", "Data")
library(ggplot2)
library(betareg)
posNegPath <- fs::path("C:", "CyToF data", "immun_aga", "posNeg panel1")
posNeg <- readRDS(fs::path(posNegPath, "posNeg.rds"))
posNegFileName <- readRDS(fs::path(posNegPath, "posNegFilnavn.rds"))

outPath <- fs::path("F:", "Forskningsprosjekter", "PDB 2794 - Immune responses aga_", "Forskningsfiler", "JOBO", "CyTOF","Analyse i R OUS", "Resultater til manuel gating")

scriptPath <- fs::path("H:", "git", "cytof")

analyseSti <- "F:/Forskningsprosjekter/PDB 2794 - Immune responses aga_/Forskningsfiler/JOBO/CyTOF/Analyse i R OUS/"
meta <- readxl::read_xlsx(fs::path(analyseSti, "STATAfil OUS pasienter FINAL 270121.xlsx"))


source(fs::path(scriptPath, "analysis_functions.R"))

surrface <- readxl::read_excel(fs::path(outPath, "Copy of panel 1 nr2.xlsx"))
surrface <- surrface[!is.na(surrface$Population),]
if(any(duplicated(surrface))){
  surrface <- surrface[-duplicated(surrface),]
}

if(any(duplicated(surrface$Population))){
  print("Need unique population names")
  print(paste0("delete last entery of: ", surrface$Population[duplicated(surrface$Population)]))
  surrface <- surrface[!duplicated(surrface),]
}

surrface <- as.data.frame(surrface)
rownames(surrface) <- surrface$Population

info <- surrface[,1:3]
surrface <- surrface[,4:ncol(surrface)]
#
colnames(surrface)[!colnames(surrface) %in% colnames(posNeg[[1]])]
colnames(posNeg[[1]])[!colnames(posNeg[[1]]) %in% colnames(surrface)]

#change colnames so that they are equal between datasets
colnames(surrface)[colnames(surrface) == "PD1"] <- "PD-1"
colnames(surrface)[colnames(surrface) == "OX40"] <- "CD134_OX40"


extra_col <- colnames(surrface)[!colnames(surrface) %in% colnames(posNeg[[1]])]
if(length(extra_col) > 0){
  print(paste0("excel file includes other columns than dataset"))
  print(paste0("column: ", extra_col, ", are deleted"))
  surrface <- surrface[,!colnames(surrface) %in% extra_col]
}



result <- matrix(NA, nrow = length(posNeg), ncol = nrow(surrface))
rownames(result) <- posNegFileName
colnames(result) <- rownames(surrface)
for(i in 1:nrow(surrface)){
  pos_i <- colnames(surrface)[which(surrface[i,] == 1)]
  neg_i <- colnames(surrface)[which(surrface[i,] == 0)]
  either_or_i <- colnames(surrface)[which(surrface[i,] == 2)]
  markers_i <- c(pos_i, neg_i)
  markersPosNeg_i <- c(rep(1, length(pos_i)), rep(0, length(neg_i)))
  if(length(markers_i) > 0){
    if(length(either_or_i) == 0){
      result[,i] <- prosent_senario(posneg = posNeg, channels = markers_i, values = markersPosNeg_i)
    } else {
      result[,i] <- prosent_senario_with_atleat_one_of_some_channels(posneg = posNeg, channels = markers_i, 
                                                                     values = markersPosNeg_i, atleast_one_of = either_or_i, value_atleast_one_of = 1)		
    }
  }
  
}


write.csv2(as.data.frame(result), fs::path(outPath, "Prosent_Gating_Panel1_nr2.csv"))



andel <- read.csv2(fs::path(outPath, "Prosent_Gating_Panel1_nr2.csv"))
# andel_bio <- read.csv2(fs::path(utSti, "antallPerClusterOgPat_bio_seed234CD3CD85CD8.csv"))
antall_andel <- ncol(andel)-1
navn_andel <- colnames(andel)[2:ncol(andel)]
rownames(andel) <- andel$X
# rownames(andel_bio) <- andel_bio$X
# 
andel$Pat <- NA
for(i in 1:nrow(andel)){
  andel$Pat[i] <- paste("FHI", substr(strsplit(rownames(andel)[i], "FHI")[[1]][2], 1,3))
}

andel$Pat[andel$Pat %in% "FHI 81_" ] <- "FHI 081"
andel$Pat[andel$Pat %in% "FHI 95_" ] <- "FHI 095"

d <- merge(andel, meta, by.x = "Pat", by.y = "Pasientnr")
d <- data.frame(d)

d$Severe <- "Severe"
#d$Severe[grepl("M_", d$X.x)] <- "Moderat"
d$Severe[grepl("M_", d$X)] <- "Moderat"


p_mat <- matrix(NA, nrow = antall_andel, ncol = 8)
colnames(p_mat) <- c("CXCL13 T1", "HI homologT1", "IFNgT1virusstamme", "IL2T1virusstamme", "Alder", "Sex", "Risiko1", "Severe")
rownames(p_mat) <- navn_andel
for(i in 1:antall_andel){
  ikkeCXCL13 <- which(d$CXCL13.T1 > 500)
  d2 <- d[- ikkeCXCL13,]
  p_mat[i,1] <- summary(lm(d2[,i+2] ~ CXCL13.T1 + Female + Alder, data = d2 ))$coeff[2,4]
  p_mat[i,2] <- summary(lm(d[,i+2] ~ HI.homolog.t1 + Female + Alder, data = d ))$coeff[2,4]
  p_mat[i,3] <- summary(lm(d[d$IFNg.t1virusstamme < 1500,i+2] ~ IFNg.t1virusstamme+ Female + Alder, data = d[d$IFNg.t1virusstamme < 1500,] ))$coeff[2,4]
  p_mat[i,4] <- summary(lm(d[d$IL2.t1virusstamme < 1000,i+2] ~ IL2.t1virusstamme+ Female + Alder, data = d[d$IL2.t1virusstamme < 1000,] ))$coeff[2,4]
  p_mat[i,5] <- summary(lm(d[,i+2] ~ Alder, data = d ))$coeff[2,4]
  p_mat[i,6] <- summary(lm(d[,i+2] ~  Female , data = d ))$coeff[2,4]
  p_mat[i,7] <- summary(lm(d[,i+2] ~ Risiko1+ Female + Alder, data = d ))$coeff[2,4]
  p_mat[i,8] <- summary(lm(d[,i+2] ~ Severe+ Female + Alder, data = d ))$coeff[2,4]
}

p_mat

surrface
```

# CD8.effector.senescent og Severe

```{r, echo = F}
fit <- betareg(CD8.effector.senescent   ~ Severe + Female , data = d )
summary(fit)


d$SevereSex <- "Male, Moderat"
d$SevereSex[d$Severe == "Severe" & d$Female == 1] <- "Female, Severe"
d$SevereSex[d$Severe == "Moderat" & d$Female == 1] <- "Female, Moderat"
d$SevereSex[d$Severe == "Severe" & d$Female == 0] <- "Male, Severe"
fit <- lm(CD8.effector.senescent   ~ SevereSex, data = d )
summary(fit)


ggplot(d, aes(x = SevereSex, y = CD8.effector.senescent)) + 
   geom_boxplot(outlier.shape = NA)+ 
   geom_jitter( alpha=0.3, position=position_jitter(0.2)) 
 
```

NB fra summary, Adjusted R-squared, ser vi at kun 11% av dataene er forklart. Fra boxplot ser vi at det er nok noen moderate menn som har mye og dette er det som gjør analysen..

# TCRgd og HI.homolog.t1 


```{r, echo = FALSE}
fit <- lm(TCRgd   ~ HI.homolog.t1  + Female + Alder, data = d )
summary(fit)
```

Her er 30% av dataene forklart, men mesteparten pga alder og kjønn. 

prøver å finne en fornuftig cutoff på mye eller lite H1.homolog.t1. men gir ikke mye mening. Er dette noe vi vil gå videre med?
```{r, echo = FALSE}
fit <- lm(TCRgd   ~ I(d$HI.homolog.t1 > 50) + Female + Alder, data = d )
summary(fit)


```


# TCRgd og Risiko 1 

```{r, echo = FALSE}
fit <- lm(TCRgd   ~ Risiko1  + Female + Alder, data = d )
summary(fit)
```

Verken alder eller kjønn signifikant, tar de ut av modellen

```{r, echo = FALSE}
fit <- lm(TCRgd   ~ Risiko1  , data = d )
summary(fit)
d$Risiko1 <- as.factor(d$Risiko1)
ggplot(d, aes(x = Risiko1, y =TCRgd))+
     geom_boxplot(outlier.shape = NA)+ 
   geom_jitter( alpha=0.3, position=position_jitter(0.2)) 

```

31% av dataene blir forklart med Risiko 1 dette er et resultat.


# TCRgd og Risiko 1 

```{r, echo = FALSE}
fit <- lm(TCRgd   ~ Severe  + Female + Alder, data = d )
summary(fit)
```

gir ingenting for Severe.

# TCRVa7.2.MAIT og IFNgT1virusstamme

```{r, echo = F}
fit <- lm(TCRVa7.2.MAIT ~ IFNg.t1virusstamme + Female + Alder, data = d[d$IFNg.t1virusstamme < 1500,])
summary(fit)
```

tror ikke dette er noe å gå videre med hvis vi ser på IFNg.t1virusstamme.



# Mo.169.active og Risiko 1 

```{r, echo = FALSE}
fit <- lm(Mo.169.active   ~ Risiko1  + Female + Alder, data = d )
summary(fit)
```

gir ingenting



# CD8.effector.senescent og Severe uten CD45RA

```{r, echo = F}
fit <- betareg(CD8.effector.senescentnr3   ~ Severe + Female + Alder, data = d )
summary(fit)

print("tar ut alder da ikke sign")

fit <- betareg(CD8.effector.senescentnr3   ~ Severe + Female , data = d )
summary(fit)


d$SevereSex <- "Male, Moderat"
d$SevereSex[d$Severe == "Severe" & d$Female == 1] <- "Female, Severe"
d$SevereSex[d$Severe == "Moderat" & d$Female == 1] <- "Female, Moderat"
d$SevereSex[d$Severe == "Severe" & d$Female == 0] <- "Male, Severe"


fit <- betareg(CD8.effector.senescentnr3 ~ SevereSex, data = d)
summary(fit)


ggplot(d, aes(x = SevereSex, y = CD8.effector.senescent)) + 
   geom_boxplot(outlier.shape = NA)+ 
   geom_jitter( alpha=0.3, position=position_jitter(0.2)) 


print("analyse kun på male")

fit <- betareg(CD8.effector.senescentnr3 ~ SevereSex, data = d[d$Female == 0,])
summary(fit)

print("analyse kun på female")

fit <- betareg(CD8.effector.senescentnr3 ~ SevereSex, data = d[d$Female == 1,])
summary(fit)

 
```